#!/usr/bin/env php
<?php
function err($err) {
    file_put_contents('php://stderr', rtrim($err) . "\n");
    exit(1);
}
set_error_handler(function($code, $msg, $file, $line) {
    err($msg . ' at ' . $file . ':' . $line);
});
$composer = json_decode(file_get_contents('composer.json'), true);

if (isset($composer['extra']['akeneo-activate-bundles'])) {
    $kernelPath = 'app/AppKernel.php';
    file_put_contents(
        $kernelPath,
        preg_replace_callback(
            '#^(\s+)(// your app bundles should be registered here).+(^\s+\];)$#Ums',
            function ($match) use ($composer) {
                $str = $match[1] . $match[2];
                foreach ($composer['extra']['akeneo-activate-bundles'] as $class) {
                    echo "Activating " . $class . "\n";
                    $str .= "\n" . $match[1] . 'new \\' . ltrim($class, '\\') . ',';
                }
                return $str . "\n" . $match[3];
            },
            file_get_contents($kernelPath)
        )
    );
}
